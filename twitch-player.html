<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #000;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: fixed;
        }
        
        #twitch-iframe {
            width: 100%;
            height: 100%;
            border: none;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 10;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: Arial, sans-serif;
            font-size: 16px;
            text-align: center;
            z-index: 5;
        }
        
        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff3333;
            font-family: Arial, sans-serif;
            font-size: 16px;
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            z-index: 20;
        }
        
        #debug-console {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1001;
            max-width: 80%;
            max-height: 200px;
            overflow: auto;
            display: none;
        }
        
        .debug-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #9146FF;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            z-index: 1002;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="twitch-container">
        <iframe id="twitch-iframe" sandbox="allow-scripts allow-same-origin allow-presentation allow-popups allow-forms"></iframe>
        <div id="loading" class="loading">Chargement de Twitch...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="debug-console"></div>
        <button class="debug-toggle" onclick="toggleDebug()">Debug</button>
    </div>

    <script>
        // Variables globales
        let channelName = '';
        let accessToken = '';
        let username = '';
        
        // Debug logging
        function debugLog(message) {
            const debugConsole = document.getElementById('debug-console');
            if (debugConsole) {
                debugConsole.innerHTML += message + '<br>';
                debugConsole.scrollTop = debugConsole.scrollHeight;
                
                // Envoyer aussi à Android pour le logcat
                if (window.AndroidBridge && typeof AndroidBridge.logMessage === 'function') {
                    AndroidBridge.logMessage(message);
                }
            }
        }
        
        function toggleDebug() {
            const debugConsole = document.getElementById('debug-console');
            debugConsole.style.display = debugConsole.style.display === 'none' ? 'block' : 'none';
        }
        
        // Fonction d'initialisation
        function initTwitchPlayer() {
            try {
                // Récupérer les paramètres de l'URL
                const urlParams = new URLSearchParams(window.location.search);
                const urlChannel = urlParams.get('channel');
                
                // Utiliser les variables injectées par Android ou les paramètres d'URL
                channelName = window.androidChannelName || urlChannel || '';
                accessToken = window.androidAccessToken || '';
                username = window.androidUsername || '';
                
                debugLog('Initialisation pour: ' + channelName);
                
                if (!channelName) {
                    showError('Nom de channel non spécifié');
                    return;
                }
                
                hideError();
                showLoading();
                
                // Charger la page mobile Twitch dans l'iframe
                loadTwitchPage();
                
            } catch (error) {
                debugLog('Erreur init: ' + error.message);
                showError('Erreur technique: ' + error.message);
            }
        }
        
        function loadTwitchPage() {
            try {
                const iframe = document.getElementById('twitch-iframe');
                
                // URL de la page mobile Twitch
                let twitchUrl = 'https://m.twitch.tv/' + channelName;
                
                debugLog('Chargement: ' + twitchUrl);
                
                iframe.onload = function() {
                    debugLog('Iframe chargée');
                    hideLoading();
                    
                    // Injecter le token après le chargement
                    setTimeout(() => {
                        if (accessToken) {
                            injectAuthentication(iframe);
                        }
                    }, 2000);
                };
                
                iframe.onerror = function() {
                    debugLog('Erreur chargement iframe');
                    showError('Erreur de chargement');
                };
                
                // Charger l'URL
                iframe.src = twitchUrl;
                
            } catch (error) {
                debugLog('Erreur loadTwitchPage: ' + error.message);
                showError('Erreur de chargement');
            }
        }
        
        // Injecter l'authentification dans l'iframe
        function injectAuthentication(iframe) {
            try {
                debugLog('Tentative injection token...');
                
                const injectScript = `
                    try {
                        // Stocker le token dans localStorage
                        localStorage.setItem('twitch_access_token', '${accessToken}');
                        localStorage.setItem('auth-token', '${accessToken}');
                        
                        // Stocker le username
                        if ('${username}') {
                            localStorage.setItem('twitch_username', '${username}');
                        }
                        
                        console.log('Token Twitch injecté avec succès');
                        
                        // Recharger pour appliquer l'authentification
                        setTimeout(() => { window.location.reload(); }, 500);
                        
                    } catch(e) {
                        console.error('Erreur injection token:', e);
                    }
                `;
                
                // Injecter le script dans l'iframe
                const script = iframe.contentDocument.createElement('script');
                script.text = injectScript;
                iframe.contentDocument.head.appendChild(script);
                
                debugLog('Token injecté');
                
            } catch (error) {
                debugLog('Erreur injection auth: ' + error.message);
                // L'authentification peut échouer à cause des politiques de sécurité, c'est normal
            }
        }
        
        // Fonctions utilitaires
        function showLoading() {
            const loading = document.getElementById('loading');
            if (loading) loading.style.display = 'block';
        }
        
        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) loading.style.display = 'none';
        }
        
        function showError(message) {
            const error = document.getElementById('error');
            if (error) {
                error.textContent = message;
                error.style.display = 'block';
            }
            hideLoading();
            
            // Signaler l'erreur à Android
            if (window.AndroidBridge && typeof AndroidBridge.onPlayerError === 'function') {
                AndroidBridge.onPlayerError(message);
            }
        }
        
        function hideError() {
            const error = document.getElementById('error');
            if (error) error.style.display = 'none';
        }
        
        // Démarrer l'initialisation
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOM chargé - Démarrage initialisation');
            
            if (window.androidChannelName) {
                initTwitchPlayer();
            } else {
                // Attendre l'injection depuis Android
                setTimeout(() => {
                    if (window.androidChannelName) {
                        initTwitchPlayer();
                    } else {
                        // Utiliser les paramètres d'URL
                        setTimeout(initTwitchPlayer, 1000);
                    }
                }, 500);
            }
        });
        
        // Gestion des erreurs globales
        window.addEventListener('error', (event) => {
            debugLog('Erreur globale: ' + event.message);
        });
        
        window.addEventListener('unhandledrejection', (event) => {
            debugLog('Promise rejetée: ' + event.reason);
        });
        
        // Exposer les fonctions globalement
        window.initTwitchPlayer = initTwitchPlayer;
        
    </script>
</body>
</html>
