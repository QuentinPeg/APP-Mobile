<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Twitch Player</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            background-color: #000;
            overflow: hidden;
            width: 100vw;
            height: 100vh;
            position: fixed;
        }
        
        #twitch-container {
            width: 100%;
            height: 100%;
            position: relative;
        }
        
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: Arial, sans-serif;
            font-size: 16px;
            text-align: center;
            z-index: 1000;
        }
        
        .error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #ff3333;
            font-family: Arial, sans-serif;
            font-size: 16px;
            text-align: center;
            padding: 20px;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 8px;
            z-index: 1000;
        }
        
        #debug-console {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            z-index: 1001;
            max-width: 80%;
            max-height: 200px;
            overflow: auto;
            display: none;
        }
        
        .debug-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #9146FF;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            z-index: 1002;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="twitch-container">
        <!-- Le contenu Twitch sera chargé ici -->
        <div id="loading" class="loading">Chargement de Twitch...</div>
        <div id="error" class="error" style="display: none;"></div>
        <div id="debug-console"></div>
        <button class="debug-toggle" onclick="toggleDebug()">Debug</button>
    </div>

    <script>
        // Variables globales
        let channelName = '';
        let accessToken = '';
        let username = '';
        
        // Debug logging
        function debugLog(message) {
            const debugConsole = document.getElementById('debug-console');
            if (debugConsole) {
                debugConsole.innerHTML += message + '<br>';
                debugConsole.scrollTop = debugConsole.scrollHeight;
                
                // Envoyer aussi à Android pour le logcat
                if (window.AndroidBridge && typeof AndroidBridge.logMessage === 'function') {
                    AndroidBridge.logMessage(message);
                }
            }
        }
        
        function toggleDebug() {
            const debugConsole = document.getElementById('debug-console');
            debugConsole.style.display = debugConsole.style.display === 'none' ? 'block' : 'none';
        }
        
        // Fonction d'initialisation
        function initTwitchPlayer() {
            try {
                // Récupérer les paramètres de l'URL
                const urlParams = new URLSearchParams(window.location.search);
                const urlChannel = urlParams.get('channel');
                
                // Utiliser les variables injectées par Android ou les paramètres d'URL
                channelName = window.androidChannelName || urlChannel || '';
                accessToken = window.androidAccessToken || '';
                username = window.androidUsername || '';
                
                debugLog('Initialisation pour: ' + channelName);
                
                if (!channelName) {
                    showError('Nom de channel non spécifié');
                    return;
                }
                
                hideError();
                showLoading();
                
                // Rediriger directement vers Twitch
                let twitchUrl = 'https://m.twitch.tv/' + channelName;
                
                if (accessToken) {
                    // Pour m.twitch.tv, l'authentification se fait via localStorage
                    injectAuthentication();
                } else {
                    // Attendre un peu puis rediriger
                    setTimeout(() => {
                        window.location.href = twitchUrl;
                    }, 1000);
                }
                
            } catch (error) {
                debugLog('Erreur init: ' + error.message);
                showError('Erreur technique');
            }
        }
        
        // Injecter l'authentification
        function injectAuthentication() {
            try {
                if (accessToken) {
                    debugLog('Injection token...');
                    
                    // Stocker le token dans localStorage
                    localStorage.setItem('twitch_access_token', accessToken);
                    localStorage.setItem('auth-token', accessToken);
                    
                    // Stocker le username
                    if (username) {
                        localStorage.setItem('twitch_username', username);
                    }
                    
                    debugLog('Token injecté, redirection...');
                    
                    // Rediriger vers Twitch
                    setTimeout(() => {
                        window.location.href = 'https://m.twitch.tv/' + channelName;
                    }, 500);
                }
            } catch (error) {
                debugLog('Erreur injection auth: ' + error.message);
                // Continuer quand même
                window.location.href = 'https://m.twitch.tv/' + channelName;
            }
        }
        
        // Fonction pour masquer les éléments indésirables (sera appelée après le chargement)
        function hideUnwantedElements() {
            try {
                debugLog('Masquage des éléments...');
                
                // Sélecteurs des éléments à masquer
                const selectorsToHide = [
                    // Chat et sidebar
                    '.chat-room', '.stream-chat', '.twitch-chat', '.live-chat',
                    '.channel-page__right-column', '.side-nav',
                    
                    // Headers et navigation
                    '.top-nav', '.header', 'nav', '.channel-header',
                    '.channel-info-content', '.stream-info',
                    
                    // Pied de page et bannières
                    'footer', '.banner', '.consent-banner', '.ad-banner',
                    
                    // Overlays et pubs
                    '.ad-container', '[class*="ad-"]', '[data-a-target*="ad-"]',
                    '.player-overlay', '.stream-display-ad'
                ];
                
                let hiddenCount = 0;
                selectorsToHide.forEach(selector => {
                    const elements = document.querySelectorAll(selector);
                    elements.forEach(el => {
                        el.style.display = 'none';
                        el.style.visibility = 'hidden';
                        el.style.opacity = '0';
                        hiddenCount++;
                    });
                });
                
                debugLog('Éléments masqués: ' + hiddenCount);
                
                // Forcer le player vidéo à prendre toute la place
                const videoSelectors = [
                    '.video-player', '[data-a-target="video-player"]',
                    '.stream-player', '.player'
                ];
                
                videoSelectors.forEach(selector => {
                    const players = document.querySelectorAll(selector);
                    players.forEach(player => {
                        player.style.position = 'absolute';
                        player.style.top = '0';
                        player.style.left = '0';
                        player.style.width = '100%';
                        player.style.height = '100%';
                        player.style.zIndex = '10';
                    });
                });
                
                // Cacher le loading une fois fait
                hideLoading();
                
            } catch (error) {
                debugLog('Erreur masquage: ' + error.message);
            }
        }
        
        // Fonctions utilitaires
        function showLoading() {
            const loading = document.getElementById('loading');
            if (loading) loading.style.display = 'block';
        }
        
        function hideLoading() {
            const loading = document.getElementById('loading');
            if (loading) loading.style.display = 'none';
        }
        
        function showError(message) {
            const error = document.getElementById('error');
            if (error) {
                error.textContent = message;
                error.style.display = 'block';
            }
            hideLoading();
        }
        
        function hideError() {
            const error = document.getElementById('error');
            if (error) error.style.display = 'none';
        }
        
        // Détecter quand la page est chargée
        let pageLoaded = false;
        
        function checkPageLoad() {
            if (pageLoaded) return;
            
            // Vérifier si Twitch est chargé
            const videoPlayer = document.querySelector('.video-player, [data-a-target="video-player"]');
            if (videoPlayer) {
                pageLoaded = true;
                debugLog('Twitch détecté, masquage...');
                hideUnwantedElements();
                
                // Vérifier périodiquement pour les éléments qui pourraient réapparaître
                setInterval(hideUnwantedElements, 3000);
            }
        }
        
        // Surveillance des changements du DOM
        const observer = new MutationObserver(checkPageLoad);
        observer.observe(document.body, { 
            childList: true, 
            subtree: true,
            attributes: true 
        });
        
        // Démarrer la surveillance
        setInterval(checkPageLoad, 1000);
        
        // Démarrer l'initialisation
        document.addEventListener('DOMContentLoaded', function() {
            debugLog('DOM chargé');
            
            if (window.androidChannelName) {
                initTwitchPlayer();
            } else {
                setTimeout(initTwitchPlayer, 500);
            }
        });
        
        // Gestion des erreurs
        window.addEventListener('error', (event) => {
            debugLog('Erreur: ' + event.message);
        });
        
        // Exposer les fonctions
        window.initTwitchPlayer = initTwitchPlayer;
        window.hideUnwantedElements = hideUnwantedElements;
        
    </script>
</body>
</html>
